# Dragon Tiger（龙虎斗）游戏详细设计文档

## 游戏概述

Dragon Tiger 是一款源于柬埔寨的经典亚洲卡牌游戏，游戏规则简单快速，玩家预测龙或虎谁的牌点数更大，或者预测平局。游戏的 RTP（玩家回报率）为 97.1%。

## 赔率计算公式

### 1. 龙投注赔率

- **基础赔率**：1:1（即 1.0）
- **佣金率**：5%（可配置）
- **实际赔率**：`1.0 × (1 - 0.05) = 0.95`

**公式：**
```
龙派彩 = 龙投注额 × 1.0 × (1 - 佣金率)
```

**示例：**
- 投注 10.00，龙赢
- 派彩 = 10.00 × 1.0 × 0.95 = 9.50

### 2. 虎投注赔率

- **基础赔率**：1:1（即 1.0）
- **佣金率**：5%（可配置）
- **实际赔率**：`1.0 × (1 - 0.05) = 0.95`

**公式：**
```
虎派彩 = 虎投注额 × 1.0 × (1 - 佣金率)
```

**示例：**
- 投注 10.00，虎赢
- 派彩 = 10.00 × 1.0 × 0.95 = 9.50

### 3. 和投注赔率

- **赔率**：1:8（即 8.0）
- **无佣金**：和投注不扣除佣金

**公式：**
```
和派彩 = 和投注额 × 8.0
```

**示例：**
- 投注 10.00，平局
- 派彩 = 10.00 × 8.0 = 80.00

### 4. 平局退款

当结果为平局时，龙/虎投注不是全部损失，而是退回 50%：

**公式：**
```
龙退款 = 龙投注额 × 0.5
虎退款 = 虎投注额 × 0.5
```

**示例：**
- 龙投注 10.00，结果平局
- 退款 = 10.00 × 0.5 = 5.00

## 派彩规则详解

### 场景 1：龙赢（`dragonCard > tigerCard`）

| 投注类型 | 派彩计算 | 结果 |
|----------|----------|------|
| 龙投注 | `投注额 × 1.0 × 0.95` | ✅ 赢得派彩 |
| 虎投注 | 0 | ❌ 损失全部 |
| 和投注 | 0 | ❌ 损失全部 |

**示例：**
- 龙投注：10.00 → 派彩 9.50
- 虎投注：5.00 → 损失 5.00
- 和投注：3.00 → 损失 3.00
- **净收益**：9.50 - 10.00 - 5.00 - 3.00 = -8.50

### 场景 2：虎赢（`tigerCard > dragonCard`）

| 投注类型 | 派彩计算 | 结果 |
|----------|----------|------|
| 龙投注 | 0 | ❌ 损失全部 |
| 虎投注 | `投注额 × 1.0 × 0.95` | ✅ 赢得派彩 |
| 和投注 | 0 | ❌ 损失全部 |

**示例：**
- 龙投注：10.00 → 损失 10.00
- 虎投注：5.00 → 派彩 4.75
- 和投注：3.00 → 损失 3.00
- **净收益**：4.75 - 10.00 - 5.00 - 3.00 = -13.25

### 场景 3：平局（`dragonCard == tigerCard`）

| 投注类型 | 派彩计算 | 结果 |
|----------|----------|------|
| 龙投注 | `投注额 × 0.5` | 🔄 退回 50% |
| 虎投注 | `投注额 × 0.5` | 🔄 退回 50% |
| 和投注 | `投注额 × 8.0` | ✅ 赢得派彩 |

**示例：**
- 龙投注：10.00 → 退回 5.00
- 虎投注：5.00 → 退回 2.50
- 和投注：3.00 → 派彩 24.00
- **总派彩**：5.00 + 2.50 + 24.00 = 31.50
- **净收益**：31.50 - 10.00 - 5.00 - 3.00 = 13.50

## 佣金机制

### 佣金配置

佣金率通过游戏配置文件 `configs/games.json` 中的 `commissionRate` 字段配置：

```json
{
  "gameId": "inhousegame:dragontiger",
  "commissionRate": "5%",
  "defaultCommissionRate": "5%"
}
```

### 佣金计算

- **仅适用于**：龙投注和虎投注的胜利派彩
- **不适用于**：和投注、平局退款
- **默认值**：5%（可配置 0%-100%）

### 佣金示例

| 佣金率 | 投注额 | 派彩计算 | 实际派彩 |
|--------|--------|----------|----------|
| 0% | 10.00 | 10.00 × 1.0 × 1.0 | 10.00 |
| 5% | 10.00 | 10.00 × 1.0 × 0.95 | 9.50 |
| 10% | 10.00 | 10.00 × 1.0 × 0.90 | 9.00 |

## 卡牌生成机制

### 可证明公平算法

Dragon Tiger 使用 SHA256 哈希算法生成可证明公平的卡牌结果。

### 种子组合

```
龙卡种子 = SHA256(serverSeed:clientSeed:nonce:0)
虎卡种子 = SHA256(serverSeed:clientSeed:nonce:1)
```

其中：
- `serverSeed`：服务端种子
- `clientSeed`：客户端种子
- `nonce`：当前游戏轮次
- `0` / `1`：卡牌索引（龙=0，虎=1）

### 卡牌映射

哈希值通过以下步骤转换为卡牌：

1. 计算 SHA256 哈希值
2. 取哈希值的前 8 位十六进制字符
3. 转换为整数（0 到 0xFFFFFFFF）
4. 归一化到 [0, 1) 范围：`value / 0xFFFFFFFF`
5. 映射到卡牌范围：`int(normalizedValue × 13) + 1`
6. 边界处理：确保结果在 1-13 之间

### 卡牌点数对照

| 点数 | 卡牌 | 说明 |
|------|------|------|
| 1 | A | Ace（最小） |
| 2-10 | 2-10 | 数字牌 |
| 11 | J | Jack |
| 12 | Q | Queen |
| 13 | K | King（最大） |

## 输赢判定规则

### 判定逻辑

```
if dragonCard > tigerCard:
    result = "dragon"
elif tigerCard > dragonCard:
    result = "tiger"
else:
    result = "tie"
```

### 判定示例

| 龙卡 | 虎卡 | 结果 | 说明 |
|------|------|------|------|
| 10 | 5 | dragon | 10 > 5，龙赢 |
| 7 | 12 | tiger | 7 < 12，虎赢 |
| 8 | 8 | tie | 8 == 8，平局 |
| 1 (A) | 13 (K) | tiger | 1 < 13，虎赢 |
| 13 (K) | 1 (A) | dragon | 13 > 1，龙赢 |

## RTP 计算

### 理论 RTP

Dragon Tiger 的 RTP 基于以下因素：
- 龙/虎投注：5% 佣金
- 和投注：1:8 赔率
- 平局退款：50%

### 龙/虎投注 RTP

```
RTP = (1 - 佣金率) × 获胜概率 + 0.5 × 平局概率
    = 0.95 × (12/13) + 0.5 × (1/13)
    = 0.95 × 0.9231 + 0.5 × 0.0769
    = 0.8769 + 0.0385
    = 91.54%
```

### 和投注 RTP

```
RTP = 赔率 × 平局概率
    = 8.0 × (1/13)
    = 61.54%
```

### 综合 RTP

实际游戏中，玩家通常同时投注多个选项（如龙+和组合），综合 RTP 约为 **97.1%**。

## 赔率对照表

### 单独投注赔率

| 投注类型 | 投注额 | 龙赢派彩 | 虎赢派彩 | 平局派彩 |
|----------|--------|----------|----------|----------|
| 龙投注 10.00 | 10.00 | 9.50 | 0.00 | 5.00 |
| 虎投注 10.00 | 10.00 | 0.00 | 9.50 | 5.00 |
| 和投注 10.00 | 10.00 | 0.00 | 0.00 | 80.00 |

### 组合投注赔率示例

#### 组合 1：龙 10.00 + 和 5.00

| 结果 | 龙派彩 | 和派彩 | 总派彩 | 净收益 |
|------|--------|--------|--------|--------|
| 龙赢 | 9.50 | 0.00 | 9.50 | -5.50 |
| 虎赢 | 0.00 | 0.00 | 0.00 | -15.00 |
| 平局 | 5.00 | 40.00 | 45.00 | +30.00 |

#### 组合 2：虎 10.00 + 和 5.00

| 结果 | 虎派彩 | 和派彩 | 总派彩 | 净收益 |
|------|--------|--------|--------|--------|
| 龙赢 | 0.00 | 0.00 | 0.00 | -15.00 |
| 虎赢 | 9.50 | 0.00 | 9.50 | -5.50 |
| 平局 | 5.00 | 40.00 | 45.00 | +30.00 |

#### 组合 3：龙 5.00 + 虎 5.00 + 和 5.00

**注意**：此组合无效！游戏规则不允许龙和虎同时投注。

## 投注限制说明

### 必要限制

1. **龙虎互斥**：`dragonBet > 0` 和 `tigerBet > 0` 不能同时成立
2. **总额要求**：`dragonBet + tigerBet + tieBet > 0`
3. **非负限制**：所有投注额必须 ≥ 0

### 限制原因

龙虎互斥的原因：
- 龙和虎是对立结果，同时投注会形成对冲
- 由于 5% 佣金，同时投注必然亏损
- 平局时只退回 50%，进一步增加亏损

### 允许的投注组合

| 龙投注 | 虎投注 | 和投注 | 是否允许 | 说明 |
|--------|--------|--------|----------|------|
| > 0 | 0 | 0 | ✅ | 单独龙投注 |
| 0 | > 0 | 0 | ✅ | 单独虎投注 |
| 0 | 0 | > 0 | ✅ | 单独和投注 |
| > 0 | 0 | > 0 | ✅ | 龙+和组合 |
| 0 | > 0 | > 0 | ✅ | 虎+和组合 |
| > 0 | > 0 | 0 | ❌ | 龙虎同时投注（禁止） |
| > 0 | > 0 | > 0 | ❌ | 龙虎同时投注（禁止） |
| 0 | 0 | 0 | ❌ | 无投注 |

## 前端实现建议

### 1. 投注界面设计

```javascript
// 龙虎投注互斥逻辑
function onDragonBetChange(value) {
  if (value > 0) {
    disableTigerBet();  // 禁用虎投注
  } else {
    enableTigerBet();   // 启用虎投注
  }
}

function onTigerBetChange(value) {
  if (value > 0) {
    disableDragonBet();  // 禁用龙投注
  } else {
    enableDragonBet();   // 启用龙投注
  }
}
```

### 2. 潜在赢利计算

```javascript
function calculatePotentialWin(dragonBet, tigerBet, tieBet, result) {
  let payout = 0;

  if (result === 'dragon') {
    payout = dragonBet * 0.95;  // 龙赢派彩
  } else if (result === 'tiger') {
    payout = tigerBet * 0.95;   // 虎赢派彩
  } else if (result === 'tie') {
    payout = dragonBet * 0.5    // 龙退款
           + tigerBet * 0.5     // 虎退款
           + tieBet * 8.0;      // 和派彩
  }

  return payout;
}
```

### 3. 显示建议

前端开发时建议显示：
1. **当前投注**：龙/虎/和的投注金额
2. **潜在赢利**：各种结果下的可能派彩
3. **赔率说明**：龙 0.95x，虎 0.95x，和 8x
4. **平局说明**：平局时龙虎退回 50%
5. **卡牌符号**：1=A, 11=J, 12=Q, 13=K
6. **游戏历史**：最近的游戏结果（龙/虎/和统计）

### 4. 卡牌显示

```javascript
function getCardSymbol(card) {
  const symbols = ['', 'A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
  return symbols[card] || card;
}

function getCardColor(result) {
  return {
    'dragon': '#f44336',  // 红色
    'tiger': '#ff9800',   // 橙色
    'tie': '#4caf50'      // 绿色
  }[result] || '#666';
}
```

### 5. 动画建议

- 发牌动画：从牌堆翻牌到龙/虎位置
- 结果高亮：胜利方卡牌高亮显示
- 派彩动画：派彩金额飞入余额区域
- 平局特效：和投注胜利时的特殊效果

## 技术实现要点

### 1. 金额精度

所有金额计算使用 `decimal.Decimal` 类型，确保精度：
- 投注金额：支持最多 8 位小数
- 派彩金额：使用 `StringFixed(8)` 格式化
- 余额更新：原子操作，确保一致性

### 2. 并发安全

- 使用数据库事务保证余额扣除和派彩的原子性
- 使用 `RETURNING` 机制获取最新余额
- 避免竞态条件导致的余额不一致

### 3. 可证明公平

- 所有卡牌生成使用确定性算法
- 种子信息记录到数据库
- 支持玩家事后验证游戏结果

### 4. 配置管理

佣金率从 `configs/games.json` 加载：
```go
commissionRate := dragontigergame.DefaultCommission  // 默认 5%
if gameConfig.CommissionRate != "" {
    var rate float64
    if _, err := fmt.Sscanf(gameConfig.CommissionRate, "%f%%", &rate); err == nil && rate > 0 {
        commissionRate = rate / 100.0
    }
}
```

## 总结

Dragon Tiger 是一款规则简单但策略丰富的卡牌游戏：
- **简单快速**：每局只发两张牌，立即出结果
- **策略选择**：龙/虎/和三种投注类型
- **公平透明**：完整的可证明公平机制
- **合理 RTP**：综合 RTP 97.1%，兼顾玩家和平台利益
